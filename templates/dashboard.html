<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸŒ¿ Carbon-Aware FL â€” Live Dashboard</title>
  <meta name="description"
    content="Real-time monitoring dashboard for the Carbon-Aware Federated Learning system. Displays accuracy trajectories, energy savings, renewable scheduling heatmap, and privacy/compression stats." />

  <!-- Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <!-- Inter font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet" />

  <style>
    /* â”€â”€ Design Tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      --bg-primary: #0d1117;
      --bg-card: #161b22;
      --bg-card-alt: #1c2330;
      --border: rgba(255, 255, 255, 0.08);
      --border-glow: rgba(39, 174, 96, 0.35);

      --green-bright: #2ecc71;
      --green-mid: #27ae60;
      --green-dim: rgba(46, 204, 113, 0.15);
      --red: #e74c3c;
      --red-dim: rgba(231, 76, 60, 0.15);
      --amber: #f39c12;
      --amber-dim: rgba(243, 156, 18, 0.15);
      --blue: #3498db;
      --purple: #9b59b6;

      --text-primary: #e6edf3;
      --text-muted: #8b949e;
      --text-dim: #484f58;

      --radius-sm: 8px;
      --radius-md: 14px;
      --radius-lg: 20px;

      --shadow-card: 0 4px 24px rgba(0, 0, 0, 0.4);
      --shadow-glow: 0 0 30px rgba(46, 204, 113, 0.12);

      --font: 'Inter', system-ui, sans-serif;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg-primary);
      color: var(--text-primary);
      font-family: var(--font);
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* â”€â”€ Animated background grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(rgba(46, 204, 113, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(46, 204, 113, 0.03) 1px, transparent 1px);
      background-size: 40px 40px;
      pointer-events: none;
      z-index: 0;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      position: relative;
      z-index: 10;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 32px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(22, 27, 34, 0.9) 0%, transparent 100%);
      backdrop-filter: blur(12px);
    }

    .header-brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .header-logo {
      width: 42px;
      height: 42px;
      background: linear-gradient(135deg, var(--green-mid), var(--green-bright));
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 0 20px rgba(46, 204, 113, 0.3);
    }

    .header-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.3px;
      background: linear-gradient(90deg, var(--green-bright), #a8e6cf);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .header-subtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .header-meta {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .status-dot {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .status-dot::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--green-bright);
      box-shadow: 0 0 8px var(--green-bright);
      animation: pulse-dot 2s ease-in-out infinite;
    }

    .status-dot.stale::before {
      background: var(--amber);
      box-shadow: 0 0 8px var(--amber);
      animation: none;
    }

    .status-dot.error::before {
      background: var(--red);
      box-shadow: 0 0 8px var(--red);
      animation: none;
    }

    @keyframes pulse-dot {

      0%,
      100% {
        opacity: 1;
        transform: scale(1);
      }

      50% {
        opacity: 0.6;
        transform: scale(0.85);
      }
    }

    #last-updated {
      font-size: 11px;
      color: var(--text-dim);
    }

    .refresh-btn {
      background: var(--bg-card-alt);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 7px 14px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-family: var(--font);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .refresh-btn:hover {
      border-color: var(--green-mid);
      color: var(--green-bright);
    }

    .refresh-btn.spinning svg {
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* â”€â”€ No-data / Error states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #no-data {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 70vh;
      gap: 16px;
      color: var(--text-muted);
      text-align: center;
    }

    #no-data .icon {
      font-size: 48px;
    }

    #no-data h2 {
      font-size: 20px;
      font-weight: 600;
      color: var(--text-primary);
    }

    #no-data p {
      font-size: 13px;
      line-height: 1.7;
      max-width: 440px;
    }

    #no-data code {
      background: var(--bg-card);
      border: 1px solid var(--border);
      padding: 2px 7px;
      border-radius: 4px;
      font-size: 12px;
      color: var(--green-bright);
    }

    /* â”€â”€ Main layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    main {
      position: relative;
      z-index: 5;
      max-width: 1440px;
      margin: 0 auto;
      padding: 28px 32px 60px;
    }

    /* â”€â”€ KPI Strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
      margin-bottom: 28px;
    }

    .kpi-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      padding: 18px 20px;
      position: relative;
      overflow: hidden;
      transition: border-color 0.2s, transform 0.2s;
    }

    .kpi-card:hover {
      border-color: var(--border-glow);
      transform: translateY(-2px);
    }

    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: var(--accent, var(--green-mid));
      border-radius: var(--radius-md) var(--radius-md) 0 0;
    }

    .kpi-label {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .kpi-value {
      font-size: 28px;
      font-weight: 800;
      margin: 6px 0 2px;
      letter-spacing: -1px;
      color: var(--accent, var(--green-bright));
    }

    .kpi-sub {
      font-size: 11px;
      color: var(--text-dim);
    }

    .kpi-badge {
      position: absolute;
      top: 14px;
      right: 14px;
      font-size: 20px;
    }

    /* â”€â”€ Section headers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 16px;
      margin-top: 32px;
    }

    .section-header h2 {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .section-header .tag {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 20px;
      background: var(--green-dim);
      color: var(--green-bright);
      border: 1px solid rgba(46, 204, 113, 0.2);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* â”€â”€ Charts grid â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .charts-grid-2 {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(480px, 1fr));
      gap: 20px;
    }

    .chart-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-card);
      transition: box-shadow 0.3s;
    }

    .chart-card:hover {
      box-shadow: var(--shadow-glow);
    }

    .chart-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 4px;
    }

    .chart-desc {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 18px;
      line-height: 1.5;
    }

    .chart-container {
      position: relative;
      height: 260px;
    }

    /* â”€â”€ Heatmap table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .heatmap-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-card);
      overflow-x: auto;
    }

    .heatmap-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 3px;
      min-width: 600px;
    }

    .heatmap-table th {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      text-align: center;
      padding: 6px 4px;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }

    .heatmap-table td {
      width: 80px;
      height: 52px;
      border-radius: 6px;
      text-align: center;
      font-size: 11px;
      font-weight: 600;
      vertical-align: middle;
      transition: transform 0.15s;
      cursor: default;
    }

    .heatmap-table td:hover {
      transform: scale(1.05);
      z-index: 1;
      position: relative;
    }

    .heatmap-table td .cell-score {
      font-size: 12px;
      display: block;
    }

    .heatmap-table td .cell-status {
      font-size: 9px;
      opacity: 0.75;
      display: block;
      margin-top: 2px;
    }

    .node-label-cell {
      text-align: left !important;
      padding-right: 12px;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
      background: transparent !important;
      white-space: nowrap;
    }

    /* â”€â”€ DP + Compression cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .bonus-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
      gap: 20px;
    }

    .bonus-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 24px;
      box-shadow: var(--shadow-card);
    }

    .bonus-card-header {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      margin-bottom: 20px;
    }

    .bonus-icon {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      flex-shrink: 0;
    }

    .bonus-icon.dp {
      background: rgba(155, 89, 182, 0.15);
    }

    .bonus-icon.comp {
      background: rgba(52, 152, 219, 0.15);
    }

    .bonus-icon.api {
      background: rgba(46, 204, 113, 0.15);
    }

    .bonus-title {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 3px;
    }

    .bonus-desc {
      font-size: 11px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 9px 0;
      border-bottom: 1px solid var(--border);
      font-size: 12px;
    }

    .stat-row:last-child {
      border-bottom: none;
    }

    .stat-key {
      color: var(--text-muted);
    }

    .stat-value {
      font-weight: 600;
      color: var(--text-primary);
    }

    .stat-value.green {
      color: var(--green-bright);
    }

    .stat-value.amber {
      color: var(--amber);
    }

    .stat-value.purple {
      color: var(--purple);
    }

    .stat-value.blue {
      color: var(--blue);
    }

    /* â”€â”€ Verdict banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .verdict-banner {
      border-radius: var(--radius-lg);
      padding: 22px 28px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      margin-top: 28px;
      flex-wrap: wrap;
    }

    .verdict-banner.pass {
      background: linear-gradient(135deg, rgba(46, 204, 113, 0.12), rgba(39, 174, 96, 0.06));
      border: 1px solid rgba(46, 204, 113, 0.25);
    }

    .verdict-banner.fail {
      background: linear-gradient(135deg, rgba(231, 76, 60, 0.12), rgba(192, 57, 43, 0.06));
      border: 1px solid rgba(231, 76, 60, 0.25);
    }

    .verdict-text h3 {
      font-size: 18px;
      font-weight: 800;
      letter-spacing: -0.5px;
    }

    .verdict-text p {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .verdict-pills {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .pill {
      padding: 6px 14px;
      border-radius: 30px;
      font-size: 12px;
      font-weight: 600;
      border: 1px solid;
    }

    .pill.green {
      background: var(--green-dim);
      border-color: rgba(46, 204, 113, 0.3);
      color: var(--green-bright);
    }

    .pill.amber {
      background: var(--amber-dim);
      border-color: rgba(243, 156, 18, 0.3);
      color: var(--amber);
    }

    .pill.blue {
      background: rgba(52, 152, 219, 0.15);
      border-color: rgba(52, 152, 219, 0.3);
      color: var(--blue);
    }

    /* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <header>
    <div class="header-brand">
      <div class="header-logo">ğŸŒ¿</div>
      <div>
        <div class="header-title">Carbon-Aware Federated Learning</div>
        <div class="header-subtitle">Live Experiment Monitor Â· v2.0-bonus</div>
      </div>
    </div>
    <div class="header-meta">
      <div class="status-dot" id="status-indicator">Live</div>
      <div id="last-updated">â€”</div>
      <button class="refresh-btn" id="refresh-btn" onclick="loadData(true)">
        <svg id="refresh-icon" width="12" height="12" viewBox="0 0 16 16" fill="currentColor">
          <path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2z" />
          <path
            d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z" />
        </svg>
        Refresh
      </button>
    </div>
  </header>

  <!-- NO-DATA STATE -->
  <div id="no-data">
    <div class="icon">ğŸ“‚</div>
    <h2>No Experiment Data Found</h2>
    <p>
      Run the experiment first to generate results:<br><br>
      <code>python3 -m carbon_fed.main --mode=comparison --rounds=10 --seed=42</code>
      <br><br>
      Then open <code>results/metrics/experiment_results.json</code> is expected
      at the same level as this dashboard file, or host via a local server:<br><br>
      <code>python3 -m http.server 8080</code> â†’ <code>http://localhost:8080</code>
    </p>
  </div>

  <!-- MAIN DASHBOARD (hidden until data loads) -->
  <main id="dashboard" style="display:none">

    <!-- KPI Strip -->
    <div class="kpi-grid" id="kpi-strip"></div>

    <!-- Accuracy Chart + Energy Chart -->
    <div class="section-header">
      <h2>Learning Trajectories</h2>
      <span class="tag">10 Rounds</span>
    </div>
    <div class="charts-grid-2">
      <div class="chart-card">
        <div class="chart-title">Global Test Accuracy (%) per Round</div>
        <div class="chart-desc">Baseline uses all nodes every round. Carbon-Aware gates participation by renewable score
          â‰¥ Î¸.</div>
        <div class="chart-container"><canvas id="accuracyChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">Cumulative Energy Consumption (kWh-eq)</div>
        <div class="chart-desc">Shaded area = energy savings achieved by skipping fossil-powered nodes.</div>
        <div class="chart-container"><canvas id="energyChart"></canvas></div>
      </div>
    </div>

    <!-- Renewable Heatmap -->
    <div class="section-header">
      <h2>Renewable Score Heatmap</h2>
      <span class="tag">Carbon-Aware</span>
    </div>
    <div class="heatmap-card">
      <div class="chart-title" style="margin-bottom:4px">Node Participation vs. Renewable Energy Availability</div>
      <div class="chart-desc" style="margin-bottom:14px">Green = active (score â‰¥ Î¸). Red = inactive. Scores shown per
        cell. Dashed line = threshold.</div>
      <div style="overflow-x:auto">
        <table class="heatmap-table" id="heatmap-table"></table>
      </div>
    </div>

    <!-- Participation Rate Chart -->
    <div class="section-header">
      <h2>Per-Round Node Participation</h2>
      <span class="tag">Carbon-Aware</span>
    </div>
    <div class="charts-grid-2">
      <div class="chart-card">
        <div class="chart-title">Active Nodes per Round (Carbon-Aware)</div>
        <div class="chart-desc">How many of the 3 nodes were activated each round based on their renewable score.</div>
        <div class="chart-container"><canvas id="participationChart"></canvas></div>
      </div>
      <div class="chart-card">
        <div class="chart-title">Energy Efficiency â€” Accuracy per kWh-eq</div>
        <div class="chart-desc">Carbon-Aware achieves higher accuracy-per-unit-energy by skipping dirty compute.</div>
        <div class="chart-container"><canvas id="efficiencyChart"></canvas></div>
      </div>
    </div>

    <!-- Bonus Feature Cards -->
    <div class="section-header">
      <h2>Bonus System Features</h2>
      <span class="tag">v2.0</span>
    </div>
    <div class="bonus-grid">

      <!-- 1. Differential Privacy -->
      <div class="bonus-card">
        <div class="bonus-card-header">
          <div class="bonus-icon dp">ğŸ”’</div>
          <div>
            <div class="bonus-title">Differential Privacy</div>
            <div class="bonus-desc">Gaussian Mechanism (Îµ, Î´)-DP applied to weight deltas before leaving the client.
              Prevents the server from inferring individual training samples.</div>
          </div>
        </div>
        <div class="stat-row"><span class="stat-key">Mechanism</span><span class="stat-value purple">Gaussian (Abadi et
            al. 2016)</span></div>
        <div class="stat-row"><span class="stat-key">Privacy Budget Îµ</span><span class="stat-value purple">2.0</span>
        </div>
        <div class="stat-row"><span class="stat-key">Failure Prob. Î´</span><span class="stat-value purple">1 Ã—
            10â»âµ</span></div>
        <div class="stat-row"><span class="stat-key">Noise Ïƒ (calibrated)</span><span class="stat-value purple"
            id="dp-sigma">â‰ˆ 0.8326</span></div>
        <div class="stat-row"><span class="stat-key">L2 Clip Norm S</span><span class="stat-value purple">1.0</span>
        </div>
        <div class="stat-row"><span class="stat-key">Error Feedback</span><span class="stat-value green">âœ“ Active</span>
        </div>
        <div class="stat-row"><span class="stat-key">Status</span><span class="stat-value green">âœ“ Ready to
            enable</span></div>
      </div>

      <!-- 2. Gradient Compression -->
      <div class="bonus-card">
        <div class="bonus-card-header">
          <div class="bonus-icon comp">ğŸ“¦</div>
          <div>
            <div class="bonus-title">Top-K Gradient Compression</div>
            <div class="bonus-desc">Transmits only the top 10% largest-magnitude weight entries per round.
              Error-feedback prevents gradient signal loss across rounds.</div>
          </div>
        </div>
        <div class="stat-row"><span class="stat-key">Algorithm</span><span class="stat-value blue">Top-K
            Sparsification</span></div>
        <div class="stat-row"><span class="stat-key">Compression Ratio</span><span class="stat-value blue">10%
            kept</span></div>
        <div class="stat-row"><span class="stat-key">Effective Sparsity</span><span class="stat-value blue">90%</span>
        </div>
        <div class="stat-row"><span class="stat-key">Error Feedback</span><span class="stat-value green">âœ“ Active</span>
        </div>
        <div class="stat-row"><span class="stat-key">Communication Saving</span><span class="stat-value blue">~10Ã— per
            round</span></div>
        <div class="stat-row"><span class="stat-key">Reference</span><span class="stat-value blue">Lin et al., ICLR
            2018</span></div>
        <div class="stat-row"><span class="stat-key">Status</span><span class="stat-value green">âœ“ Ready to
            enable</span></div>
      </div>

      <!-- 3. Live Carbon API -->
      <div class="bonus-card">
        <div class="bonus-card-header">
          <div class="bonus-icon api">ğŸŒ</div>
          <div>
            <div class="bonus-title">Live Carbon API Integration</div>
            <div class="bonus-desc">Fetches real-time carbon intensity from electricityMap or WattTime with TTL-based
              caching. Falls back to sinusoidal simulation automatically.</div>
          </div>
        </div>
        <div class="stat-row"><span class="stat-key">Primary Provider</span><span
            class="stat-value green">electricityMap v3</span></div>
        <div class="stat-row"><span class="stat-key">Secondary Provider</span><span class="stat-value green">WattTime
            v3</span></div>
        <div class="stat-row"><span class="stat-key">Fallback</span><span class="stat-value green">Sinusoidal
            Model</span></div>
        <div class="stat-row"><span class="stat-key">Cache TTL</span><span class="stat-value green">3600 s (free
            tier)</span></div>
        <div class="stat-row"><span class="stat-key">Config via</span><span class="stat-value green">Env vars /
            LiveCarbonConfig</span></div>
        <div class="stat-row"><span class="stat-key">Default Zone</span><span class="stat-value green">DE
            (Germany)</span></div>
        <div class="stat-row"><span class="stat-key">Current Mode</span><span class="stat-value amber">âŸ³ Simulation (no
            API key)</span></div>
      </div>

    </div>

    <!-- Verdict Banner -->
    <div class="verdict-banner" id="verdict-banner">
      <div class="verdict-text">
        <h3 id="verdict-title">â€”</h3>
        <p id="verdict-sub">â€”</p>
      </div>
      <div class="verdict-pills" id="verdict-pills"></div>
    </div>

  </main>

  <script>
    /* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const $ = id => document.getElementById(id);
    const fmt = (n, d = 2) => (+n).toFixed(d);
    const pct = n => fmt(n * 100, 1) + '%';

    // Chart.js global defaults
    Chart.defaults.color = '#8b949e';
    Chart.defaults.font.family = "'Inter', system-ui, sans-serif";
    Chart.defaults.font.size = 11;

    const PALETTE = {
      red: '#e74c3c',
      redFill: 'rgba(231,76,60,0.08)',
      green: '#2ecc71',
      greenFill: 'rgba(46,204,113,0.08)',
      amber: '#f39c12',
      blue: '#3498db',
      purple: '#9b59b6',
      grid: 'rgba(255,255,255,0.05)',
    };

    let charts = {};

    function destroyCharts() {
      Object.values(charts).forEach(c => c?.destroy());
      charts = {};
    }

    /* â”€â”€ Score â†’ heatmap colour â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function scoreToColor(score, alpha = 1) {
      // 0 â†’ red, 0.6 â†’ amber, 1 â†’ green
      const r = score < 0.5 ? 1 : 1 - (score - 0.5) * 2;
      const g = score < 0.5 ? score * 2 : 1;
      const ri = Math.round(r * 220);
      const gi = Math.round(g * 200);
      return `rgba(${ri}, ${gi}, 40, ${alpha})`;
    }

    /* â”€â”€ KPI strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderKPIs(d) {
      const cmp = d.comparison;
      const base = d.baseline_results;
      const carbon = d.carbon_results;

      const kpis = [
        { label: 'Baseline Accuracy', value: fmt(base.final_accuracy * 100, 2) + '%', sub: 'All nodes active', accent: '#e74c3c', icon: 'ğŸ¯' },
        { label: 'Carbon-Aware Acc.', value: fmt(carbon.final_accuracy * 100, 2) + '%', sub: `Î” = +${fmt(cmp.accuracy_degradation_pp, 2)} pp`, accent: '#2ecc71', icon: 'ğŸŒ¿' },
        { label: 'Energy Savings', value: fmt(cmp.energy_savings_percent, 1) + '%', sub: `${fmt(cmp.carbon_total_energy, 1)} vs ${fmt(cmp.baseline_total_energy, 1)} kWh-eq`, accent: '#f39c12', icon: 'âš¡' },
        { label: 'Avg Participation', value: pct(carbon.avg_participation_rate), sub: 'Renewable-gated nodes', accent: '#3498db', icon: 'ğŸ”Œ' },
        { label: 'Convergence Round', value: `R${base.convergence_round}`, sub: 'Both experiments converge round 1', accent: '#9b59b6', icon: 'ğŸ“ˆ' },
        { label: 'Experiment ID', value: d.experiment_id.slice(0, 8) + 'â€¦', sub: new Date(d.timestamp).toLocaleString(), accent: '#484f58', icon: 'ğŸ†”' },
      ];

      $('kpi-strip').innerHTML = kpis.map(k => `
    <div class="kpi-card" style="--accent:${k.accent}">
      <div class="kpi-label">${k.label}</div>
      <div class="kpi-value">${k.value}</div>
      <div class="kpi-sub">${k.sub}</div>
      <div class="kpi-badge">${k.icon}</div>
    </div>
  `).join('');
    }

    /* â”€â”€ Accuracy Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderAccuracyChart(d) {
      const rounds = d.baseline_results.per_round.map(r => `R${r.round}`);
      const baseAcc = d.baseline_results.per_round.map(r => +(r.global_accuracy * 100).toFixed(3));
      const carbAcc = d.carbon_results.per_round.map(r => +(r.global_accuracy * 100).toFixed(3));

      charts.accuracy = new Chart($('accuracyChart'), {
        type: 'line',
        data: {
          labels: rounds,
          datasets: [
            {
              label: 'Baseline (All Nodes)',
              data: baseAcc,
              borderColor: PALETTE.red,
              backgroundColor: PALETTE.redFill,
              borderWidth: 2.5,
              pointRadius: 4,
              pointHoverRadius: 7,
              tension: 0.3,
              fill: false,
            },
            {
              label: 'Carbon-Aware',
              data: carbAcc,
              borderColor: PALETTE.green,
              backgroundColor: PALETTE.greenFill,
              borderWidth: 2.5,
              borderDash: [5, 3],
              pointRadius: 4,
              pointHoverRadius: 7,
              tension: 0.3,
              fill: false,
            },
          ],
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { padding: 16, usePointStyle: true } },
            tooltip: { mode: 'index', intersect: false },
          },
          scales: {
            x: { grid: { color: PALETTE.grid } },
            y: {
              min: Math.min(...baseAcc, ...carbAcc) - 0.5,
              max: 100.2,
              grid: { color: PALETTE.grid },
              ticks: { callback: v => v + '%' },
            },
          },
        },
      });
    }

    /* â”€â”€ Energy Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderEnergyChart(d) {
      const rounds = d.baseline_results.per_round.map(r => `R${r.round}`);
      const baseEn = d.baseline_results.per_round.map(r => +r.cumulative_energy.toFixed(3));
      const carbEn = d.carbon_results.per_round.map(r => +r.cumulative_energy.toFixed(3));

      charts.energy = new Chart($('energyChart'), {
        type: 'line',
        data: {
          labels: rounds,
          datasets: [
            {
              label: 'Baseline Energy',
              data: baseEn,
              borderColor: PALETTE.red,
              backgroundColor: 'rgba(231,76,60,0.06)',
              borderWidth: 2.5,
              pointRadius: 4,
              fill: 'origin',
              tension: 0.2,
            },
            {
              label: 'Carbon-Aware Energy',
              data: carbEn,
              borderColor: PALETTE.green,
              backgroundColor: 'rgba(46,204,113,0.08)',
              borderWidth: 2.5,
              borderDash: [5, 3],
              pointRadius: 4,
              fill: 'origin',
              tension: 0.2,
            },
          ],
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { padding: 16, usePointStyle: true } },
            tooltip: {
              mode: 'index', intersect: false,
              callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.raw} kWh-eq` },
            },
          },
          scales: {
            x: { grid: { color: PALETTE.grid } },
            y: { grid: { color: PALETTE.grid }, ticks: { callback: v => v + ' kWh' } },
          },
        },
      });
    }

    /* â”€â”€ Participation Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderParticipationChart(d) {
      const rounds = d.carbon_results.per_round.map(r => `R${r.round}`);
      const active = d.carbon_results.per_round.map(r => r.active_nodes.length);
      const maxNodes = 3;

      charts.participation = new Chart($('participationChart'), {
        type: 'bar',
        data: {
          labels: rounds,
          datasets: [
            {
              label: 'Active Nodes',
              data: active,
              backgroundColor: active.map(v =>
                v === maxNodes ? PALETTE.green : v >= 2 ? PALETTE.amber : PALETTE.red
              ),
              borderRadius: 5,
              maxBarThickness: 36,
            },
          ],
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => ` ${ctx.raw}/${maxNodes} nodes active`,
                afterLabel: ctx => {
                  const r = d.carbon_results.per_round[ctx.dataIndex];
                  return ` Active: ${r.active_nodes.join(', ')}`;
                },
              },
            },
            annotation: {
              annotations: {
                maxLine: {
                  type: 'line',
                  yMin: maxNodes, yMax: maxNodes,
                  borderColor: 'rgba(231,76,60,0.4)',
                  borderDash: [5, 3],
                  label: { content: 'Max (Baseline)', display: true, position: 'start', color: '#e74c3c', font: { size: 10 } },
                },
              },
            },
          },
          scales: {
            x: { grid: { color: PALETTE.grid } },
            y: { min: 0, max: maxNodes + 0.5, grid: { color: PALETTE.grid }, ticks: { stepSize: 1 } },
          },
        },
      });
    }

    /* â”€â”€ Efficiency Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderEfficiencyChart(d) {
      const rounds = d.baseline_results.per_round.map(r => `R${r.round}`);
      const baseEff = d.baseline_results.per_round.map(r =>
        +((r.global_accuracy * 100) / Math.max(r.cumulative_energy, 0.01)).toFixed(4)
      );
      const carbEff = d.carbon_results.per_round.map(r =>
        +((r.global_accuracy * 100) / Math.max(r.cumulative_energy, 0.01)).toFixed(4)
      );

      charts.efficiency = new Chart($('efficiencyChart'), {
        type: 'line',
        data: {
          labels: rounds,
          datasets: [
            { label: 'Baseline', data: baseEff, borderColor: PALETTE.red, borderWidth: 2, pointRadius: 3, tension: 0.3, fill: false },
            { label: 'Carbon-Aware', data: carbEff, borderColor: PALETTE.green, borderWidth: 2, borderDash: [5, 3], pointRadius: 3, tension: 0.3, fill: false },
          ],
        },
        options: {
          responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { padding: 16, usePointStyle: true } },
            tooltip: { mode: 'index', intersect: false, callbacks: { label: ctx => ` ${ctx.dataset.label}: ${ctx.raw.toFixed(3)} acc/kWh` } },
          },
          scales: {
            x: { grid: { color: PALETTE.grid } },
            y: { grid: { color: PALETTE.grid }, ticks: { callback: v => v.toFixed(2) } },
          },
        },
      });
    }

    /* â”€â”€ Heatmap â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderHeatmap(d) {
      const rounds = d.carbon_results.per_round;
      const nodes = ['Alpha', 'Beta', 'Gamma'];
      const theta = d.configuration.threshold;

      let html = '<thead><tr><th>Node</th>';
      rounds.forEach(r => { html += `<th>R${r.round}</th>`; });
      html += '</tr></thead><tbody>';

      nodes.forEach(node => {
        html += `<tr><td class="node-label-cell">â¬¡ ${node}</td>`;
        rounds.forEach(r => {
          const score = r.renewable_scores?.[node] ?? 0;
          const active = r.active_nodes.includes(node);
          const bg = scoreToColor(score, 0.88);
          const fg = score > 0.5 ? '#fff' : '#fff';
          const mark = active ? 'âœ“' : 'âœ—';
          html += `<td style="background:${bg};color:${fg}">
        <span class="cell-score">${score.toFixed(2)}</span>
        <span class="cell-status">${mark}</span>
      </td>`;
        });
        html += '</tr>';
      });
      html += '</tbody>';
      $('heatmap-table').innerHTML = html;
    }

    /* â”€â”€ DP sigma display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderDPSigma() {
      const eps = 2.0, delta = 1e-5, S = 1.0;
      const sigma = Math.sqrt(2 * Math.log(1.25 / delta)) * S / eps;
      $('dp-sigma').textContent = 'â‰ˆ ' + sigma.toFixed(4);
    }

    /* â”€â”€ Verdict Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderVerdict(d) {
      const cmp = d.comparison;
      const savings = cmp.energy_savings_percent;
      const delta_pp = cmp.accuracy_degradation_pp;
      const pass = savings >= 20 && Math.abs(delta_pp) <= 5;

      const banner = $('verdict-banner');
      banner.className = `verdict-banner ${pass ? 'pass' : 'fail'}`;
      $('verdict-title').textContent = pass
        ? 'âœ… Experiment PASSED â€” Success Criteria Met'
        : 'âš ï¸ Experiment REVIEW â€” Check Criteria';
      $('verdict-sub').textContent =
        `Energy savings â‰¥ 20% (got ${savings.toFixed(1)}%) AND accuracy Î” â‰¤ 5 pp (got +${delta_pp.toFixed(2)} pp)`;

      $('verdict-pills').innerHTML = [
        { label: `âš¡ ${savings.toFixed(1)}% energy saved`, cls: 'green' },
        { label: `ğŸ¯ Î” accuracy: +${delta_pp.toFixed(2)} pp`, cls: delta_pp <= 5 ? 'green' : 'amber' },
        { label: `ğŸ”Œ ${pct(cmp.carbon_avg_participation_rate)} avg participation`, cls: 'blue' },
        { label: `ğŸ“ Seed 42 Â· Î¸=${d.configuration.threshold}`, cls: 'blue' },
      ].map(p => `<div class="pill ${p.cls}">${p.label}</div>`).join('');
    }

    /* â”€â”€ Main data loader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    async function loadData(manual = false) {
      const btn = $('refresh-btn');
      const icon = $('refresh-icon');
      const indicator = $('status-indicator');

      btn.classList.add('spinning');

      // Try multiple relative paths for the JSON file
      const paths = [
        '/api/metrics',                               // Main API endpoint
        './metrics/experiment_results.json',          // when served from results/ dir
        './results/metrics/experiment_results.json',  // when served from project root
        './experiment_results.json',                  // flat fallback
      ];

      let data = null;
      for (const p of paths) {
        try {
          const resp = await fetch(p + '?t=' + Date.now());
          if (resp.ok) { data = await resp.json(); break; }
        } catch (_) { }
      }

      btn.classList.remove('spinning');

      if (!data) {
        $('no-data').style.display = 'flex';
        $('dashboard').style.display = 'none';
        indicator.className = 'status-dot error';
        indicator.textContent = 'No Data';
        return;
      }

      // Show dashboard
      $('no-data').style.display = 'none';
      $('dashboard').style.display = 'block';
      indicator.className = 'status-dot';
      indicator.textContent = 'Live';
      $('last-updated').textContent = 'Updated ' + new Date().toLocaleTimeString();

      destroyCharts();

      renderKPIs(data);
      renderAccuracyChart(data);
      renderEnergyChart(data);
      renderParticipationChart(data);
      renderEfficiencyChart(data);
      renderHeatmap(data);
      renderDPSigma();
      renderVerdict(data);
    }

    /* â”€â”€ Auto-refresh every 30s â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    loadData();
    setInterval(() => loadData(), 30_000);
  </script>
</body>

</html>